version: 2
jobs:
    build-duo-contract-wrapper:
        working_directory: /home/circleci/duo-contract-wrapper
        docker: 
            - image: circleci/node:8.11.1
        steps:
            - run: git clone https://github.com/FinBook/duo-contract-wrapper.git /home/circleci/duo-contract-wrapper
            - run: cd /home/circleci/duo-contract-wrapper
            - restore_cache:
                key: dependency-cache-{{ .Environment.CIRCLE_SHA1 }}
            - run:
                name: Install npm wee
                command: npm install
            - save_cache:
                key: dependency-cache-{{ .Environment.CIRCLE_SHA1 }}
                paths:
                    - /home/circleci/duo-contract-wrapper
    push-repo:
        working_directory: /home/circleci/
        docker:
            - image: circleci/node:8.11.1
        steps:
            - add_ssh_keys:
                fingerprints:            
                    - "3d:80:45:8e:e6:d2:fd:fd:9b:94:73:80:b3:6c:3e:c2"
                    - "48:4b:53:58:5a:d6:34:40:e1:43:32:03:9f:85:96:bc"
            - restore_cache:
                key: dependency-cache-{{ .Environment.CIRCLE_SHA1 }}
            - run:
                name: Fix host authenticity for 192.30.253.113
                command: |
                    ssh-keyscan 192.30.253.113 >> ~/.ssh/known_hosts
            - run: git init
            - run: git remote add origin git@192.30.253.113:lipeiru0329/testCircleCI.git
            - run: git fetch
            - run: git pull
            - run: git add *
            - run: git commit -m 'update'
            - run: git push --force origin master
workflows:
    version: 2
    build_test_deploy:
        jobs:
            - build-duo-contract-wrapper
            - push-repo:
                requires:
                    - build-duo-contract-wrapper